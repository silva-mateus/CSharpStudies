# JD02 - SQL Querying Fundamentals

## Difficulty: Easy
## Estimated Time: 30-45 minutes
## Type: Write SQL queries (no C# code)

## Overview

Given a pre-built database schema with seed data in SQL Server LocalDB, write 12 SQL queries of increasing complexity. This exercise tests your SQL querying skills against a realistic relational schema.

## Setup

1. Ensure SQL Server LocalDB is installed (comes with Visual Studio).
2. Open a SQL Server connection to `(localdb)\MSSQLLocalDB`.
3. Run `schema-and-seed.sql` to create the database `JD02_QueryExercise` with tables and sample data.
4. Write your solutions in `queries.sql`.

## Schema

The database has 6 tables:

| Table | Key Columns |
|-------|-------------|
| `Departments` | Id, Name, Budget |
| `Employees` | Id, FirstName, LastName, Email, Salary, HireDate, DepartmentId (FK), ManagerId (FK, self-ref) |
| `Customers` | Id, Name, Email, City, Country, CreatedAt |
| `Products` | Id, Name, Category, Price, StockQuantity |
| `Orders` | Id, CustomerId (FK), OrderDate, Status ('Pending','Shipped','Delivered','Cancelled') |
| `OrderItems` | Id, OrderId (FK), ProductId (FK), Quantity, UnitPrice |

## Queries to Write (in queries.sql)

Write each query under its numbered comment block. Each comment includes the expected result description.

1. **Basic SELECT**: All employees in the 'Engineering' department, ordered by salary descending.
2. **INNER JOIN**: All orders with customer name and total item count per order.
3. **LEFT JOIN**: All customers who have never placed an order.
4. **GROUP BY + HAVING**: Departments with average salary above $80,000.
5. **Subquery in WHERE**: Employees who earn more than the average salary of their department.
6. **Correlated subquery**: For each product, show the product name and the total quantity ever ordered.
7. **CTE**: Using a CTE, find the top 3 customers by total spending (sum of quantity * unit price across all orders).
8. **ROW_NUMBER**: Rank employees within each department by salary (highest first), showing rank, name, department, salary.
9. **Running total**: Show orders chronologically with a running total of order amounts (sum of quantity * unit price).
10. **PIVOT**: Show total sales per product category per month for the current year (categories as columns).
11. **Multi-table report**: A management report showing: department name, employee count, average salary, total order revenue generated by customers served by that department's employees (assume no direct link -- join creatively or use a simplified version).
12. **UPDATE + DELETE**: (a) Update all 'Pending' orders older than 30 days to 'Cancelled'. (b) Delete all order items for cancelled orders.

## Constraints

- Use SQL Server T-SQL syntax.
- Each query must be self-contained (no temporary tables carrying between queries, except #10 PIVOT which may use a CTE).
- Include comments explaining your approach for complex queries.

## Topics Covered

- SELECT, WHERE, ORDER BY
- INNER JOIN, LEFT JOIN
- GROUP BY, HAVING
- Subqueries (scalar, correlated)
- Common Table Expressions (CTEs)
- Window functions (ROW_NUMBER, RANK, SUM OVER)
- PIVOT
- UPDATE with JOIN, DELETE with subquery
